# Story 2.2: User Info Endpoint with Tenant Discovery

## Status
Ready for Review

## Story
**As a** user,
**I want** to retrieve my profile and list of tenants I can access,
**so that** the Shell UI can display available tenants for selection.

## Acceptance Criteria
1. GET /api/me endpoint requires Bearer token authentication (user access token)
2. JWT validation middleware extracts and validates user token, rejecting invalid/expired tokens with 401
3. Endpoint extracts user_id (sub) and tenant_ids from validated JWT claims
4. Endpoint queries database for user record matching user_id
5. Endpoint queries database for tenant records WHERE id IN tenant_ids AND is_active = 1
6. Endpoint queries user_tenants table to get role for each tenant
7. Response returns: {user_id, email, tenants: [{id, name, slug, role, config_json}, ...]}
8. Tenants array sorted alphabetically by name
9. If user_id from JWT not found in database, returns 404 with "USER_NOT_FOUND" error
10. If no active tenants found, returns empty tenants array (not an error)
11. Endpoint logs request with user_id and number of tenants returned
12. Unit tests verify tenant filtering and role mapping
13. Integration test verifies end-to-end flow with mock JWT

## Tasks / Subtasks

- [x] **Task 1: Create JWT validation middleware** (AC: 1, 2, 3)
  - [ ] Create `apps/api/src/middleware/auth.py` module
  - [ ] Import JWT validation utilities from shared_config: `validate_user_token`, `validate_tenant_token`
  - [ ] Create `get_current_user` dependency function for FastAPI
  - [ ] Extract Authorization header and parse Bearer token
  - [ ] Call `validate_user_token()` to decode and validate JWT
  - [ ] Handle invalid/expired token with 401 HTTPException using standard error format
  - [ ] Extract claims: user_id (sub), email, tenant_ids
  - [ ] Return validated user claims as dependency result
  - [ ] Add error handling for missing Authorization header (401)
  - [ ] Add error handling for malformed token (401)

- [x] **Task 2: Create user info endpoint** (AC: 1, 4, 7, 9, 11)
  - [x] Create `apps/api/src/routers/user.py` with APIRouter instance
  - [x] Define GET `/api/me` endpoint handler
  - [x] Add `get_current_user` dependency to endpoint signature
  - [x] Create Pydantic response model: `UserInfoResponse(user_id: str, email: str, tenants: List[TenantInfo])`
  - [x] Create Pydantic model: `TenantInfo(id: str, name: str, slug: str, role: str, config_json: dict)`
  - [x] Query database for user record matching user_id
  - [x] Handle user not found case with 404 error (code: "USER_NOT_FOUND")
  - [x] Add logging for request with user_id and tenant count
  - [x] Register user router in `main.py` with `/api` prefix

- [x] **Task 3: Implement tenant discovery query** (AC: 5, 6, 8, 10)
  - [x] Create database query function in `apps/api/src/database/queries.py`
  - [x] Function: `get_user_tenants(user_id: str, tenant_ids: List[str]) -> List[dict]`
  - [x] SQL query: JOIN tenants with user_tenants table
  - [x] Filter: WHERE tenants.id IN tenant_ids AND is_active = 1
  - [x] Include role from user_tenants.role column
  - [x] Order results: ORDER BY tenants.name ASC (alphabetical)
  - [x] Handle empty result set (return empty list, not error)
  - [x] Parse config_json from TEXT to dict
  - [x] Test query with mock data (Acme Corp, Beta Industries)

- [x] **Task 4: Integrate database queries with endpoint** (AC: 4, 5, 6, 7, 10)
  - [x] Import database connection from `apps/api/src/database/connection.py`
  - [x] Call `get_user_tenants()` with user_id and tenant_ids from JWT
  - [x] Transform query results into TenantInfo Pydantic models
  - [x] Construct UserInfoResponse with user data and tenant list
  - [x] Handle case where tenant_ids array is empty (return empty tenants list)
  - [x] Verify response JSON structure matches specification

- [x] **Task 5: Write unit tests for JWT validation middleware** (AC: 2, 12)
  - [x] Create `apps/api/tests/test_middleware_auth.py`
  - [x] Test valid user token is accepted and claims extracted
  - [x] Test expired token returns 401 with proper error format
  - [x] Test invalid signature returns 401
  - [x] Test missing Authorization header returns 401
  - [x] Test malformed Bearer token returns 401
  - [x] Test token with missing claims returns 401
  - [x] Verify error responses match standard format

- [x] **Task 6: Write unit tests for user info endpoint** (AC: 12)
  - [x] Create `apps/api/tests/test_user.py`
  - [x] Mock database queries for consistent test data
  - [x] Test successful user info retrieval with single tenant
  - [x] Test successful retrieval with multi-tenant user (admin@acme.com)
  - [x] Test tenant filtering (only active tenants returned)
  - [x] Test role mapping from user_tenants table
  - [x] Test alphabetical sorting of tenants
  - [x] Test 404 when user_id not in database
  - [x] Test empty tenants array when no active tenants

- [x] **Task 7: Write integration test for full user info flow** (AC: 13)
  - [x] Create integration test using TestClient
  - [x] Generate valid user token using shared_config.encode_user_token()
  - [x] Call GET /api/me with Authorization: Bearer <token>
  - [x] Verify response structure matches UserInfoResponse
  - [x] Test with analyst@acme.com (single tenant) - expect 1 tenant
  - [x] Test with admin@acme.com (multi-tenant) - expect 2 tenants sorted
  - [x] Test with viewer@beta.com (single tenant) - expect 1 tenant
  - [x] Verify tenant data includes: id, name, slug, role, config_json
  - [x] Test with invalid token returns 401

- [x] **Task 8: Add API documentation and OpenAPI spec** (AC: 11)
  - [x] Add OpenAPI docstring to /api/me endpoint
  - [x] Document Bearer token authentication requirement
  - [x] Add request/response examples to auto-generated docs
  - [x] Document error responses (401, 404)
  - [x] Tag endpoint as "User" in Swagger UI
  - [x] Add security requirement to OpenAPI spec

## Dev Notes

### Project Context
This is the **second story** in Epic 2 (Mock Authentication & Token Exchange). This story implements the user profile and tenant discovery endpoint, enabling the Shell UI to display available tenants after authentication.

### Previous Story Insights
Story 2.1 implemented mock login that generates user access tokens. This story consumes those tokens and validates them using the JWT middleware pattern.

### Architecture References

**API Specification** [Source: architecture/5-api-specification.md]

Endpoint contract:
```
GET /api/me
Headers: Authorization: Bearer <user_access_token>
Response: {
  "user_id": "uuid",
  "email": "analyst@acme.com",
  "tenants": [
    {
      "id": "uuid",
      "name": "Acme Corporation",
      "slug": "acme-corp",
      "role": "viewer",
      "config_json": {
        "branding": {...},
        "features": {...}
      }
    }
  ]
}
```

Error responses:
- 401: Invalid/expired token or missing Authorization header
- 404: User ID from token not found in database

**Backend Architecture** [Source: architecture/10-backend-architecture.md]

File structure:
- Middleware: `apps/api/src/middleware/auth.py`
- Router: `apps/api/src/routers/user.py`
- Models: `apps/api/src/models/tenant.py`
- Database: `apps/api/src/database/queries.py`

Middleware pattern:
```python
from fastapi import Depends, HTTPException
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials

security = HTTPBearer()

async def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security)
) -> dict:
    token = credentials.credentials
    try:
        payload = validate_user_token(token)
        return payload
    except Exception as e:
        raise HTTPException(status_code=401, detail="Invalid token")
```

**Database Schema** [Source: architecture/8-database-schema.md, Epic 1 Story 1.3]

Relevant tables:
```sql
-- users table
users (
  id TEXT PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  created_at TEXT
)

-- tenants table
tenants (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  is_active INTEGER DEFAULT 1,
  config_json TEXT,
  created_at TEXT
)

-- user_tenants junction table
user_tenants (
  user_id TEXT REFERENCES users(id),
  tenant_id TEXT REFERENCES tenants(id),
  role TEXT NOT NULL,  -- 'admin', 'viewer', etc.
  PRIMARY KEY (user_id, tenant_id)
)
```

Query pattern:
```sql
SELECT
  t.id, t.name, t.slug, t.config_json,
  ut.role
FROM tenants t
JOIN user_tenants ut ON t.id = ut.tenant_id
WHERE ut.user_id = ?
  AND t.id IN (?)  -- tenant_ids from JWT
  AND t.is_active = 1
ORDER BY t.name ASC
```

**JWT Validation** [Source: Epic 1 Story 1.2, shared_config module]

Import validation utilities:
```python
from shared_config import validate_user_token, validate_tenant_token

# Returns decoded claims or raises exception
payload = validate_user_token(token)
# payload = {
#   "sub": "user-uuid",
#   "email": "analyst@acme.com",
#   "tenant_ids": ["uuid1", "uuid2"],
#   "iat": 1234567890,
#   "exp": 1234571490
# }
```

**Error Handling** [Source: architecture/17-error-handling-strategy.md]

Middleware 401 errors:
```python
raise HTTPException(
    status_code=401,
    detail={
        "error": {
            "code": "INVALID_TOKEN",
            "message": "Token is invalid or expired",
            "timestamp": datetime.utcnow().isoformat(),
            "request_id": str(uuid.uuid4())
        }
    }
)
```

404 user not found:
```python
raise HTTPException(
    status_code=404,
    detail={
        "error": {
            "code": "USER_NOT_FOUND",
            "message": f"User {user_id} not found",
            "timestamp": datetime.utcnow().isoformat(),
            "request_id": str(uuid.uuid4())
        }
    }
)
```

**Logging** [Source: architecture/18-monitoring-and-observability.md]

Log user info requests:
```python
logger.info(
    "User info request",
    extra={
        "user_id": user_id,
        "email": email,
        "tenant_count": len(tenants),
        "timestamp": datetime.utcnow().isoformat()
    }
)
```

### Testing

**Test Framework:** pytest with FastAPI TestClient

**Test Locations:**
- `apps/api/tests/test_middleware_auth.py` (middleware tests)
- `apps/api/tests/test_user.py` (endpoint tests)

**Test Standards** [Source: architecture/15-testing-strategy.md]

Unit test requirements:
1. JWT validation middleware tests (valid/invalid/expired tokens)
2. User info endpoint logic tests (with mocked database)
3. Tenant filtering and sorting tests
4. Role mapping tests
5. Error handling tests (401, 404)

Integration test requirements:
1. Full HTTP request cycle with real JWT tokens
2. Test all 3 mock users with their tenant configurations
3. Verify response data structure and content
4. Verify database queries execute correctly

**Mock Data for Testing:**
- analyst@acme.com: 1 tenant (Acme Corporation, role: viewer)
- admin@acme.com: 2 tenants (Acme + Beta, role: admin)
- viewer@beta.com: 1 tenant (Beta Industries, role: viewer)

**Test Pattern:**
```python
def test_user_info_single_tenant(client):
    # Generate user token
    from shared_config import encode_user_token
    token = encode_user_token(
        user_id="user-uuid",
        email="analyst@acme.com",
        tenant_ids=["acme-uuid"]
    )

    # Call endpoint
    response = client.get(
        "/api/me",
        headers={"Authorization": f"Bearer {token}"}
    )

    # Assertions
    assert response.status_code == 200
    data = response.json()
    assert data["email"] == "analyst@acme.com"
    assert len(data["tenants"]) == 1
    assert data["tenants"][0]["slug"] == "acme-corp"
```

### Dependencies
- **Depends on:** Story 2.1 (Mock Authentication Endpoint) - generates user tokens
- **Depends on:** Epic 1 Story 1.2 (Shared Configuration) - JWT validation
- **Depends on:** Epic 1 Story 1.3 (Tenant Metadata Database) - database queries
- **Blocks:** Story 2.3 (Token Exchange) - provides tenant list for selection

### Security Considerations
- JWT validation must check signature, expiration, and issuer
- Middleware must reject tokens without required claims
- Only return active tenants (is_active = 1)
- Role information must come from user_tenants table, not JWT claims
- config_json may contain sensitive tenant configuration - ensure proper access control

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 0.1 | Initial story creation from Epic 2 | Sarah (PO Agent) |
| 2025-10-12 | 1.0 | Story implementation completed | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (claude-sonnet-4-5-20250929)

### Debug Log References
- Fixed database query column name: used `user_id` instead of `id` to match actual schema
- Fixed middleware return type: converted Pydantic `UserAccessToken` model to dict using `model_dump()`

### Completion Notes List
- Created JWT validation middleware at apps/api/src/middleware/auth.py with HTTPBearer security
- Implemented get_current_user dependency function that validates Bearer tokens
- Middleware extracts and validates JWT, returns claims as dict for dependency injection
- Created user info endpoint at apps/api/src/routers/user.py with GET /api/me
- Created Pydantic models TenantInfo and UserInfoResponse in apps/api/src/models/tenant.py
- Implemented database queries: get_user_by_id() and get_user_tenants() in apps/api/src/database/queries.py
- Tenant query joins tenants with user_tenants table, filters active tenants, sorts alphabetically
- Parses config_json from TEXT to dict automatically in query function
- Added comprehensive unit tests for middleware in apps/api/tests/test_middleware_auth.py
- Added unit tests for user endpoint in apps/api/tests/test_user.py with mocked database
- Added integration tests in apps/api/tests/test_user_integration.py
- Registered user router in main.py with /api prefix
- Added pytest-asyncio dependency to requirements.txt for async test support
- Tested successfully with all 3 mock users (analyst@acme.com, admin@acme.com, viewer@beta.com)
- Endpoint returns proper 200 responses with user_id, email, and tenants array
- Tenants sorted alphabetically: "Acme Corporation" before "Beta Industries"
- Role mapping works correctly: admin@acme.com has admin role, others have viewer role
- Error handling verified: 401 for invalid tokens, 404 for missing users

### File List
**Created:**
- `apps/api/src/middleware/__init__.py` - Middleware package init with get_current_user export
- `apps/api/src/middleware/auth.py` - JWT validation middleware with HTTPBearer security
- `apps/api/src/models/tenant.py` - TenantInfo and UserInfoResponse Pydantic models
- `apps/api/src/database/queries.py` - Database query functions (get_user_by_id, get_user_tenants)
- `apps/api/src/routers/user.py` - User info router with GET /api/me endpoint
- `apps/api/tests/test_middleware_auth.py` - Unit tests for JWT middleware (8 test cases)
- `apps/api/tests/test_user.py` - Unit tests for user endpoint (8 test cases)
- `apps/api/tests/test_user_integration.py` - Integration tests for full user info flow (10 test cases)

**Modified:**
- `apps/api/src/main.py` - Added user router import and registration
- `apps/api/src/models/__init__.py` - Added TenantInfo and UserInfoResponse exports
- `apps/api/requirements.txt` - Added pytest-asyncio>=0.21.0 for async tests

## QA Results
_(To be filled by QA Agent)_
