# Story 1.4: Docker Compose Orchestration Setup

## Status
Ready for Review

## Story
**As a** developer,
**I want** Docker Compose configuration that orchestrates all services with proper networking and volume mounts,
**so that** I can start the entire PoC with a single command and services can communicate.

## Acceptance Criteria
1. docker-compose.yml defines services: shell-ui, api, dash-app-clv, dash-app-risk
2. shell-ui service: builds from apps/shell-ui/Dockerfile, exposes port 3000, depends on api service
3. api service: builds from apps/api/Dockerfile, exposes port 8000, mounts data/ volume for SQLite access
4. dash-app-clv service: builds from apps/dash-app-clv/Dockerfile, exposes port 8050, depends on api service
5. dash-app-risk service: builds from apps/dash-app-risk/Dockerfile, exposes port 8051, depends on api service
6. All services connected via Docker network named kyros-net for inter-service communication
7. Environment variables configured for each service (database path, API URLs, JWT secret)
8. Volume mounts configured for: data/ (database and mock data), shared-config/ (Python package)
9. Each service Dockerfile created with appropriate base image (node:20 for Shell UI, python:3.11 for others)
10. Dockerfiles install dependencies and set up working directories correctly
11. `docker-compose up --build` successfully starts all services without errors

## Tasks / Subtasks
- [ ] **Task 1: Create docker-compose.yml structure** (AC: 1, 6)
  - [ ] Create root `docker-compose.yml` file
  - [ ] Define version (3.8 or higher)
  - [ ] Define custom network `kyros-net` with bridge driver
  - [ ] Define volume mounts for shared data
  - [ ] Add comments documenting service purposes

- [ ] **Task 2: Define api service configuration** (AC: 3, 7, 8)
  - [ ] Configure service name: `api`
  - [ ] Set build context to `apps/api/`
  - [ ] Set Dockerfile path
  - [ ] Expose port 8000:8000
  - [ ] Mount `./data:/app/data` for database access
  - [ ] Mount `./packages/shared-config:/app/packages/shared-config` for shared config
  - [ ] Set environment variables: DATABASE_PATH, JWT_SECRET_KEY
  - [ ] Connect to kyros-net network
  - [ ] Set container restart policy: unless-stopped

- [ ] **Task 3: Define shell-ui service configuration** (AC: 2, 7)
  - [ ] Configure service name: `shell-ui`
  - [ ] Set build context to `apps/shell-ui/`
  - [ ] Set Dockerfile path
  - [ ] Expose port 3000:3000
  - [ ] Set depends_on: api
  - [ ] Set environment variables: API_BASE_URL=http://api:8000
  - [ ] Connect to kyros-net network
  - [ ] Set container restart policy: unless-stopped

- [ ] **Task 4: Define dash-app-clv service configuration** (AC: 4, 7, 8)
  - [ ] Configure service name: `dash-app-clv`
  - [ ] Set build context to `apps/dash-app-clv/`
  - [ ] Set Dockerfile path
  - [ ] Expose port 8050:8050
  - [ ] Set depends_on: api
  - [ ] Mount `./packages/shared-config:/app/packages/shared-config`
  - [ ] Set environment variables: API_BASE_URL, JWT_SECRET_KEY
  - [ ] Connect to kyros-net network
  - [ ] Set container restart policy: unless-stopped

- [ ] **Task 5: Define dash-app-risk service configuration** (AC: 5, 7, 8)
  - [ ] Configure service name: `dash-app-risk`
  - [ ] Set build context to `apps/dash-app-risk/`
  - [ ] Set Dockerfile path
  - [ ] Expose port 8051:8051
  - [ ] Set depends_on: api
  - [ ] Mount `./packages/shared-config:/app/packages/shared-config`
  - [ ] Set environment variables: API_BASE_URL, JWT_SECRET_KEY
  - [ ] Connect to kyros-net network
  - [ ] Set container restart policy: unless-stopped

- [ ] **Task 6: Create Dockerfile for api service** (AC: 9, 10)
  - [ ] Create `apps/api/Dockerfile`
  - [ ] Use base image: `python:3.11-slim`
  - [ ] Set working directory to `/app`
  - [ ] Copy requirements.txt and install Python dependencies
  - [ ] Copy shared-config package and install in editable mode
  - [ ] Copy application source code
  - [ ] Expose port 8000
  - [ ] Set CMD to run uvicorn with FastAPI app

- [ ] **Task 7: Create Dockerfile for shell-ui service** (AC: 9, 10)
  - [ ] Create `apps/shell-ui/Dockerfile`
  - [ ] Use base image: `node:20-alpine`
  - [ ] Set working directory to `/app`
  - [ ] Copy package.json and package-lock.json
  - [ ] Run npm install
  - [ ] Copy application source code
  - [ ] Run npm build
  - [ ] Expose port 3000
  - [ ] Set CMD to run Next.js production server

- [ ] **Task 8: Create Dockerfile for dash-app-clv service** (AC: 9, 10)
  - [ ] Create `apps/dash-app-clv/Dockerfile`
  - [ ] Use base image: `python:3.11-slim`
  - [ ] Set working directory to `/app`
  - [ ] Copy requirements.txt and install dependencies
  - [ ] Copy shared-config package and install
  - [ ] Copy application source code
  - [ ] Expose port 8050
  - [ ] Set CMD to run Dash app

- [ ] **Task 9: Create Dockerfile for dash-app-risk service** (AC: 9, 10)
  - [ ] Create `apps/dash-app-risk/Dockerfile`
  - [ ] Use base image: `python:3.11-slim`
  - [ ] Set working directory to `/app`
  - [ ] Copy requirements.txt and install dependencies
  - [ ] Copy shared-config package and install
  - [ ] Copy application source code
  - [ ] Expose port 8051
  - [ ] Set CMD to run Dash app

- [ ] **Task 10: Create .env.example template** (AC: 7)
  - [ ] Create `.env.example` file at root
  - [ ] Document all environment variables for each service
  - [ ] Include JWT_SECRET_KEY with warning to change in production
  - [ ] Include database path: `/app/data/tenant_metadata.db`
  - [ ] Include API URLs for service-to-service communication
  - [ ] Add comments explaining each variable

- [ ] **Task 11: Create .dockerignore files** (AC: 10)
  - [ ] Create `.dockerignore` at root
  - [ ] Create `apps/shell-ui/.dockerignore` excluding node_modules, .next, dist
  - [ ] Create `apps/api/.dockerignore` excluding __pycache__, *.pyc, venv
  - [ ] Create `apps/dash-app-clv/.dockerignore` excluding Python artifacts
  - [ ] Create `apps/dash-app-risk/.dockerignore` excluding Python artifacts

- [ ] **Task 12: Test Docker Compose orchestration** (AC: 11)
  - [ ] Run `docker-compose up --build` from root
  - [ ] Verify all 4 services build successfully
  - [ ] Verify all services start without errors
  - [ ] Verify services can communicate via kyros-net
  - [ ] Test health endpoints: curl http://localhost:8000/health
  - [ ] Verify shell-ui accessible at http://localhost:3000
  - [ ] Check logs for each service: `docker-compose logs <service>`
  - [ ] Test graceful shutdown: `docker-compose down`

- [ ] **Task 13: Document Docker usage** (AC: 11)
  - [ ] Update root README.md with Docker quick start
  - [ ] Document `docker-compose up --build` command
  - [ ] Document how to view logs: `docker-compose logs -f`
  - [ ] Document how to rebuild specific service: `docker-compose build <service>`
  - [ ] Document how to stop services: `docker-compose down`
  - [ ] Document port mappings for all services
  - [ ] Add troubleshooting section for common Docker issues

## Dev Notes

### Project Context
This is the **fourth story** in Epic 1 (Foundation & Shared Configuration). Docker Compose orchestration enables one-command startup of all services, which is critical for Epic 2+ stories that require multiple services running simultaneously.

### Previous Story Insights
- Story 1.1: Established monorepo structure
- Story 1.2: Created shared-config package (must be mounted in Python containers)
- Story 1.3: Created database at data/tenant_metadata.db (must be mounted in api container)

All Dockerfiles must account for these dependencies.

### Docker Compose Structure
[Source: architecture/3-tech-stack.md + architecture/11-unified-project-structure.md]

**Service Architecture:**
- **shell-ui** (Next.js): Frontend, port 3000, depends on api
- **api** (FastAPI): Backend API, port 8000, needs database volume
- **dash-app-clv** (Dash): Dashboard 1, port 8050, depends on api
- **dash-app-risk** (Dash): Dashboard 2, port 8051, depends on api

**Network:** Custom bridge network `kyros-net` enables service-to-service communication using service names as hostnames (e.g., `http://api:8000`).

### Complete docker-compose.yml
[Source: prd/epic-1 AC #1-8]

```yaml
version: '3.8'

services:
  # ============================================================================
  # FastAPI Backend Service
  # ============================================================================
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: kyros-api
    ports:
      - "8000:8000"
    environment:
      - DATABASE_PATH=/app/data/tenant_metadata.db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-kyros-poc-secret-key-CHANGE-IN-PRODUCTION-12345678}
    volumes:
      - ./data:/app/data                                    # Database access
      - ./packages/shared-config:/app/packages/shared-config  # Shared JWT config
    networks:
      - kyros-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Next.js Shell UI Service
  # ============================================================================
  shell-ui:
    build:
      context: ./apps/shell-ui
      dockerfile: Dockerfile
    container_name: kyros-shell-ui
    ports:
      - "3000:3000"
    environment:
      - API_BASE_URL=http://api:8000
      - NODE_ENV=production
    depends_on:
      - api
    networks:
      - kyros-net
    restart: unless-stopped

  # ============================================================================
  # Dash App: Customer Lifetime Value
  # ============================================================================
  dash-app-clv:
    build:
      context: ./apps/dash-app-clv
      dockerfile: Dockerfile
    container_name: kyros-dash-clv
    ports:
      - "8050:8050"
    environment:
      - API_BASE_URL=http://api:8000
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-kyros-poc-secret-key-CHANGE-IN-PRODUCTION-12345678}
    volumes:
      - ./packages/shared-config:/app/packages/shared-config
    depends_on:
      - api
    networks:
      - kyros-net
    restart: unless-stopped

  # ============================================================================
  # Dash App: Risk Analysis
  # ============================================================================
  dash-app-risk:
    build:
      context: ./apps/dash-app-risk
      dockerfile: Dockerfile
    container_name: kyros-dash-risk
    ports:
      - "8051:8051"
    environment:
      - API_BASE_URL=http://api:8000
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-kyros-poc-secret-key-CHANGE-IN-PRODUCTION-12345678}
    volumes:
      - ./packages/shared-config:/app/packages/shared-config
    depends_on:
      - api
    networks:
      - kyros-net
    restart: unless-stopped

# ==============================================================================
# Networks
# ==============================================================================
networks:
  kyros-net:
    driver: bridge
    name: kyros-net
```

### Dockerfile for FastAPI (apps/api/Dockerfile)
[Source: architecture/3-tech-stack.md + architecture/10-backend-architecture.md]

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy and install shared-config package
COPY ../../packages/shared-config /app/packages/shared-config
RUN pip install -e /app/packages/shared-config

# Copy application source
COPY src/ /app/src/

# Expose port
EXPOSE 8000

# Run FastAPI with uvicorn
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
```

### Dockerfile for Next.js (apps/shell-ui/Dockerfile)
[Source: architecture/3-tech-stack.md + architecture/9-frontend-architecture.md]

```dockerfile
FROM node:20-alpine AS base

# Stage 1: Dependencies
FROM base AS deps
WORKDIR /app

COPY package.json package-lock.json ./
RUN npm ci

# Stage 2: Build
FROM base AS builder
WORKDIR /app

COPY --from=deps /app/node_modules ./node_modules
COPY . .

RUN npm run build

# Stage 3: Production
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production

COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

EXPOSE 3000

CMD ["node", "server.js"]
```

### Dockerfile for Dash Apps (apps/dash-app-clv/Dockerfile and apps/dash-app-risk/Dockerfile)
[Source: architecture/3-tech-stack.md]

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Copy and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy and install shared-config package
COPY ../../packages/shared-config /app/packages/shared-config
RUN pip install -e /app/packages/shared-config

# Copy application source
COPY src/ /app/src/

# Expose port (8050 for CLV, 8051 for Risk)
EXPOSE 8050

# Run Dash app
CMD ["python", "src/app.py"]
```

### Environment Variables
[Source: architecture/16-coding-standards.md + prd/epic-1 AC #7]

**.env.example:**
```bash
# ============================================================================
# Kyros SaaS PoC - Environment Variables
# ============================================================================

# JWT Configuration
# ⚠️ CRITICAL: Change this secret in production!
JWT_SECRET_KEY=kyros-poc-secret-key-CHANGE-IN-PRODUCTION-12345678

# Database Configuration
DATABASE_PATH=/app/data/tenant_metadata.db

# API URLs (used by frontend and Dash apps)
API_BASE_URL=http://api:8000

# Node Environment
NODE_ENV=production
```

### .dockerignore Patterns
[Source: Best practices]

**Root .dockerignore:**
```
node_modules/
.next/
dist/
build/
__pycache__/
*.pyc
*.pyo
.pytest_cache/
.coverage
htmlcov/
.env
.env.local
.git/
.gitignore
README.md
docs/
tests/
*.md
.DS_Store
```

**apps/shell-ui/.dockerignore:**
```
node_modules/
.next/
dist/
*.log
.env*.local
coverage/
```

**apps/api/.dockerignore (and Dash apps):**
```
__pycache__/
*.pyc
*.pyo
.pytest_cache/
.venv/
venv/
*.egg-info/
.coverage
htmlcov/
```

### Service Dependencies and Startup Order
[Source: prd/epic-1 AC #2, #4, #5]

**Startup Order:**
1. `api` starts first (no dependencies)
2. `shell-ui`, `dash-app-clv`, `dash-app-risk` wait for `api` via `depends_on`

**Health Checks:**
- API service includes healthcheck to verify availability
- Other services use `depends_on` to wait for API container start
- For full health checking (Epic 2+), use `depends_on` with `condition: service_healthy`

### Volume Mount Strategy
[Source: prd/epic-1 AC #8]

**Critical Mounts:**
1. `./data:/app/data` - API needs access to tenant_metadata.db
2. `./packages/shared-config:/app/packages/shared-config` - All Python apps need JWT config

**Why not copy in Dockerfile?**
- Database file is generated by seed script at runtime
- Shared-config is installed as editable package for development

### Testing Docker Compose
[Source: architecture/15-testing-strategy.md]

**Manual Validation Steps:**
1. Build all services: `docker-compose build`
2. Start all services: `docker-compose up`
3. Verify API health: `curl http://localhost:8000/health`
4. Verify Shell UI: `curl http://localhost:3000`
5. Check logs: `docker-compose logs -f api`
6. Test inter-service networking: `docker exec kyros-api curl http://dash-app-clv:8050`
7. Stop services: `docker-compose down`

**Common Issues:**
- Port already in use: Change port mapping in docker-compose.yml
- Database not found: Run `python scripts/seed-database.py` before `docker-compose up`
- Permission errors: Check file permissions on data/ directory

### Documentation Requirements
[Source: prd/epic-1 AC #11]

Update root README.md with:
- **Docker Quick Start** section
- Command: `docker-compose up --build`
- Port mappings: 3000 (UI), 8000 (API), 8050 (CLV), 8051 (Risk)
- Log viewing: `docker-compose logs -f <service>`
- Troubleshooting section

### Testing
[Source: architecture/15-testing-strategy.md]

**No automated tests required** - validation is manual Docker testing.

**Definition of Done:**
- docker-compose.yml defines all 4 services
- All Dockerfiles created and functional
- All services build without errors
- All services start and run successfully
- Services can communicate via kyros-net
- Volume mounts work correctly
- Environment variables configured
- .env.example created
- .dockerignore files prevent unnecessary file copying
- Documentation complete in README
- `docker-compose up --build` works end-to-end

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-11 | 0.1 | Initial story creation from Epic 1 | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
_(To be filled during implementation)_

### Debug Log References
_(To be filled during implementation)_

### Completion Notes List
_(To be filled during implementation)_

### File List
**Created:**
_(To be filled during implementation)_

**Modified:**
_(To be filled during implementation)_

## QA Results
_(To be filled by QA Agent)_
