# Story 3.2: Authentication Context and Token Management

## Status
Dev Complete - Pending Manual Test

## Story
**As a** Shell UI developer,
**I want** centralized auth state management with token storage,
**so that** authenticated state and tokens are accessible throughout the application.

## Acceptance Criteria
1. Auth context created with React Context API providing: {isAuthenticated, userToken, login(token), logout()}
2. Auth provider wraps root layout (app/layout.tsx)
3. User access token stored in React state (not localStorage for PoC simplicity)
4. login(token) function stores token and sets isAuthenticated = true
5. logout() function clears token and sets isAuthenticated = false
6. useAuth() hook provides access to auth context from any component
7. AuthGuard component created that redirects to /login if not authenticated
8. AuthGuard wraps protected routes (home page, tenant pages)
9. On app mount, auth context checks for existing token (future: could check /api/me)
10. TypeScript types defined for auth context interface

## Tasks / Subtasks

- [x] **Task 1: Create auth context** (AC: 1, 3, 4, 5)
  - [x] Create `apps/shell-ui/contexts/AuthContext.tsx`
  - [x] Define AuthContextType interface
  - [x] Create AuthContext with createContext
  - [x] Implement AuthProvider component with state management
  - [x] Implement login(token) function
  - [x] Implement logout() function
  - [x] Export AuthProvider and useAuth hook

- [x] **Task 2: Create useAuth hook** (AC: 6)
  - [x] Implement useAuth() hook using useContext
  - [x] Add error handling if used outside provider
  - [x] Export hook for component use

- [x] **Task 3: Wrap root layout with provider** (AC: 2)
  - [x] Modify `apps/shell-ui/app/layout.tsx`
  - [x] Import and wrap children with AuthProvider
  - [x] Ensure provider at top level for app-wide access

- [x] **Task 4: Create AuthGuard component** (AC: 7, 8)
  - [x] Create `apps/shell-ui/components/auth/AuthGuard.tsx`
  - [x] Check isAuthenticated from useAuth()
  - [x] Redirect to /login if not authenticated
  - [x] Render children if authenticated

- [x] **Task 5: Implement token persistence check** (AC: 9)
  - [x] On AuthProvider mount, check sessionStorage for token
  - [x] If token exists, validate and set authenticated state
  - [x] Clear invalid tokens from storage

- [x] **Task 6: Define TypeScript types** (AC: 10)
  - [x] Create AuthContextType interface
  - [x] Define token storage types
  - [x] Export types for component use

## Dev Notes

### Project Context
This is the **second story** in Epic 3. This story creates the centralized authentication state management that all other Epic 3 stories will depend on.

### Architecture Pattern

**Context Structure:**
```typescript
interface AuthContextType {
  isAuthenticated: boolean
  userToken: string | null
  login: (token: string) => void
  logout: () => void
}
```

**Token Flow:**
```
Login Success → login(token) → Store in React State → isAuthenticated = true
Logout → logout() → Clear State → isAuthenticated = false
Page Load → Check sessionStorage → Restore token if valid
```

### Dependencies
- **Depends on:** Epic 1 Story 1.6 (Next.js Shell UI)
- **Blocks:** Story 3.1 (Login Page) - will use login() function
- **Blocks:** Story 3.3 (Tenant Selection) - requires auth context

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | 0.1 | Initial story creation from Epic 3 PRD | Sarah (PO Agent) |
| 2025-10-15 | 1.0 | Implementation complete | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
- Model: claude-sonnet-4-5-20250929
- Agent: Dev Agent (James)
- Date: 2025-10-15

### Debug Log References
None - implementation completed without errors.

### Completion Notes List

**Implementation Complete:**

1. **AuthContext Created** (contexts/AuthContext.tsx)
   - React Context API with `createContext<AuthContextType>()`
   - AuthContextType interface exported: `{isAuthenticated, userToken, login(), logout()}`
   - State management with `useState` for `userToken` and `isAuthenticated`
   - Token persistence on mount using `useEffect` with sessionStorage check
   - JWT format validation (3 parts separated by dots)
   - Error handling for invalid tokens
   - Future-ready for `/api/me` token validation

2. **useAuth Hook** (contexts/AuthContext.tsx)
   - Custom hook using `useContext(AuthContext)`
   - Error handling: throws error if used outside AuthProvider
   - Clear error message: "useAuth must be used within an AuthProvider"

3. **login() Function** (AC 4)
   - Sets `userToken` state
   - Sets `isAuthenticated = true`
   - Persists token to sessionStorage

4. **logout() Function** (AC 5)
   - Clears `userToken` state
   - Sets `isAuthenticated = false`
   - Removes token from sessionStorage

5. **Root Layout Updated** (app/layout.tsx)
   - Imported AuthProvider from `@/contexts/AuthContext`
   - Wrapped children with `<AuthProvider>{children}</AuthProvider>`
   - Provider at top level for app-wide access

6. **AuthGuard Component Created** (components/auth/AuthGuard.tsx)
   - Uses `useAuth()` to check authentication status
   - Uses `useRouter()` and `usePathname()` from Next.js
   - Redirects to `/login` if not authenticated
   - Prevents flash of protected content with loading state
   - Shows loading spinner during auth check
   - Renders children only when authenticated

7. **Home Page Protected** (app/page.tsx)
   - Wrapped HomePage component with AuthGuard
   - Added logout button with `logout()` function
   - Displays authentication status and token preview
   - Shows note about future tenant selection (Story 3.3)

8. **Login Page Updated** (app/login/page.tsx)
   - Imported `useAuth` hook
   - Replaced `sessionStorage.setItem()` with `login()` function
   - Maintains all existing functionality
   - Integrates seamlessly with auth context

**Architecture Decisions:**
- Used React Context API (not Redux or Zustand) for simplicity
- Token stored in both React state and sessionStorage
- React state for immediate access, sessionStorage for persistence
- Basic JWT validation (format check only, no signature verification)
- Token validation with `/api/me` left as TODO for future enhancement
- AuthGuard shows loading state to prevent flash of protected content

**Testing Status:**
- All 10 Acceptance Criteria implemented
- All 6 tasks completed
- Manual testing pending (requires Docker services)

**Integration Points:**
- Story 3.1 login page now uses auth context
- Home page protected with AuthGuard
- Ready for Story 3.3 tenant selection

### File List
**Created:**
- contexts/AuthContext.tsx (87 lines)
- components/auth/AuthGuard.tsx (50 lines)

**Modified:**
- app/layout.tsx (added AuthProvider wrapper)
- app/page.tsx (added AuthGuard, logout button, auth status display)
- app/login/page.tsx (replaced sessionStorage with login() function)

## QA Results
_(To be filled by QA Agent)_
