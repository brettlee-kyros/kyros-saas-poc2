# Story 2.1: Mock Authentication Endpoint with Pre-Generated JWTs

## Status
Ready for Review

## Story
**As a** user,
**I want** to log in with my email address and receive a user access token,
**so that** I can proceed to select a tenant from those I have access to.

## Acceptance Criteria
1. POST /api/auth/mock-login endpoint accepts {email: string} request body
2. Endpoint looks up user in mock data from shared_config module
3. If user found, endpoint generates user access token JWT with claims: sub (user_id), email, tenant_ids (array of UUIDs), iat, exp (1 hour)
4. JWT signed with shared JWT_SECRET_KEY using HS256 algorithm
5. Response returns {access_token: string, token_type: "Bearer", expires_in: 3600}
6. If user not found, returns 404 with error: {error: {code: "USER_NOT_FOUND", message: "User with email ... not found"}}
7. Mock users defined in shared-config: analyst@acme.com (Acme only), admin@acme.com (Acme + Beta), viewer@beta.com (Beta only)
8. Endpoint logs authentication attempt with email and success/failure
9. Unit tests verify JWT claims structure and signature validation
10. Integration test verifies full login flow with valid and invalid emails

## Tasks / Subtasks

- [x] **Task 1: Create auth router and mock login endpoint** (AC: 1, 2, 5, 6, 8)
  - [ ] Create `apps/api/src/routers/auth.py` with APIRouter instance
  - [ ] Import FastAPI dependencies (APIRouter, HTTPException, status)
  - [ ] Define POST `/api/auth/mock-login` endpoint handler
  - [ ] Create Pydantic request model: `MockLoginRequest(email: str)`
  - [ ] Create Pydantic response model: `TokenResponse(access_token: str, token_type: str, expires_in: int)`
  - [ ] Import `get_user_by_email` from shared_config module
  - [ ] Implement user lookup logic in endpoint handler
  - [ ] Handle user not found case with 404 error response using standard error format
  - [ ] Add logging for authentication attempts (success/failure)
  - [ ] Register auth router in `main.py` with `/api/auth` prefix

- [x] **Task 2: Implement JWT user token generation** (AC: 3, 4, 7)
  - [ ] Import JWT utilities from shared_config: `encode_user_token`, `JWT_SECRET_KEY`, `JWT_ALGORITHM`
  - [ ] Extract user data from mock user lookup (user_id, email, tenant_ids)
  - [ ] Construct JWT payload with required claims: sub, email, tenant_ids, iat, exp
  - [ ] Set exp claim to current timestamp + 3600 seconds (1 hour)
  - [ ] Call `encode_user_token()` to generate signed JWT
  - [ ] Return TokenResponse with access_token, token_type="Bearer", expires_in=3600
  - [ ] Verify mock users exist in shared_config with correct tenant mappings

- [x] **Task 3: Implement standardized error handling** (AC: 6)
  - [ ] Create error response helper function or use existing error middleware
  - [ ] Ensure error responses match architecture standard format:
    ```json
    {
      "error": {
        "code": "USER_NOT_FOUND",
        "message": "User with email xyz@example.com not found",
        "timestamp": "2024-01-15T10:30:00Z",
        "request_id": "uuid"
      }
    }
    ```
  - [ ] Generate unique request_id for error tracking (UUID)
  - [ ] Include ISO 8601 timestamp in all error responses

- [x] **Task 4: Write unit tests for mock login endpoint** (AC: 9)
  - [ ] Create `apps/api/tests/test_auth.py`
  - [ ] Set up test fixtures for FastAPI TestClient
  - [ ] Test successful login with valid email (analyst@acme.com)
  - [ ] Verify JWT claims structure (sub, email, tenant_ids, iat, exp)
  - [ ] Verify JWT signature can be validated with JWT_SECRET_KEY
  - [ ] Test 404 response for non-existent user email
  - [ ] Test error response format matches standard
  - [ ] Verify token_type is "Bearer"
  - [ ] Verify expires_in is 3600

- [x] **Task 5: Write integration test for full login flow** (AC: 10)
  - [ ] Create integration test that calls POST /api/auth/mock-login
  - [ ] Test with all 3 mock users (analyst@acme.com, admin@acme.com, viewer@beta.com)
  - [ ] Decode returned JWT and verify tenant_ids array matches expected tenants
  - [ ] Test with invalid email and verify 404 response
  - [ ] Test with malformed email format and verify appropriate error
  - [ ] Verify token can be used in Authorization header for subsequent requests

- [x] **Task 6: Add API documentation and logging** (AC: 8)
  - [ ] Add OpenAPI docstring to endpoint with request/response examples
  - [ ] Document that this is PoC-only (not production-ready authentication)
  - [ ] Add structured logging with email and outcome (success/failure)
  - [ ] Log warning for production use disclaimer
  - [ ] Update FastAPI auto-generated docs to show endpoint in "Mock Auth" tag

## Dev Notes

### Project Context
This is the **first story** in Epic 2 (Mock Authentication & Token Exchange). This story implements the entry point for user authentication in the PoC, setting the foundation for the token exchange pattern validated in subsequent stories.

### Previous Story Insights
Epic 1 established the shared_config module with JWT utilities and mock user data. This story leverages that shared infrastructure to generate user access tokens.

### Architecture References

**API Specification** [Source: architecture/5-api-specification.md]

Endpoint contract:
```
POST /api/auth/mock-login
Request:  { "email": "analyst@acme.com" }
Response: {
  "access_token": "eyJ...",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

Error response format:
```json
{
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "User with email ... not found",
    "timestamp": "2024-01-15T10:30:00Z",
    "request_id": "uuid"
  }
}
```

**Backend Architecture** [Source: architecture/10-backend-architecture.md]

File location:
- Router: `apps/api/src/routers/auth.py`
- Models: `apps/api/src/models/tokens.py` (Pydantic request/response models)
- Register in: `apps/api/src/main.py`

**Mock User Data** [Source: Epic 1 Story 1.2, shared_config module]

Mock users available from shared_config:
```python
from shared_config import get_user_by_email, MOCK_USERS

# Returns: {
#   "user_id": "uuid",
#   "email": "analyst@acme.com",
#   "tenant_ids": ["acme-corp-uuid"]
# }
```

Three mock users defined:
1. `analyst@acme.com` - Single tenant (Acme Corporation), role: Viewer
2. `admin@acme.com` - Multi-tenant (Acme + Beta Industries), role: Admin
3. `viewer@beta.com` - Single tenant (Beta Industries), role: Viewer

**JWT Configuration** [Source: Epic 1 Story 1.2, shared_config module]

JWT settings from shared_config:
```python
from shared_config import (
    JWT_SECRET_KEY,        # Shared secret for signing
    JWT_ALGORITHM,         # "HS256"
    JWT_ISSUER,           # "kyros-poc"
    USER_TOKEN_EXPIRY,    # 3600 seconds (1 hour)
    encode_user_token     # Utility function
)
```

User token JWT claims structure:
```json
{
  "sub": "user-uuid",           // User ID
  "email": "analyst@acme.com",
  "tenant_ids": ["uuid1", "uuid2"],  // Array of accessible tenants
  "iat": 1234567890,            // Issued at timestamp
  "exp": 1234571490,            // Expires at (iat + 3600)
  "iss": "kyros-poc"            // Issuer
}
```

**Error Handling** [Source: architecture/17-error-handling-strategy.md]

Standard error response must include:
- `error.code`: Machine-readable error code (e.g., "USER_NOT_FOUND")
- `error.message`: Human-readable message
- `error.timestamp`: ISO 8601 timestamp
- `error.request_id`: Unique UUID for tracing

Use FastAPI HTTPException with appropriate status codes:
- 404: User not found
- 400: Invalid request format
- 500: Internal server errors

**Logging** [Source: architecture/18-monitoring-and-observability.md]

Log authentication attempts with structured logging:
```python
logger.info(
    "Authentication attempt",
    extra={
        "email": email,
        "success": True/False,
        "timestamp": datetime.utcnow().isoformat()
    }
)
```

### Testing

**Test Framework:** pytest with FastAPI TestClient

**Test Location:** `apps/api/tests/test_auth.py`

**Test Standards** [Source: architecture/15-testing-strategy.md]

Unit tests requirements:
1. Test successful authentication with valid email
2. Test JWT claims structure and content
3. Test JWT signature validation
4. Test 404 error for invalid email
5. Test error response format compliance
6. Test token expiry calculation (expires_in = 3600)

Integration test requirements:
1. Full HTTP request/response cycle test
2. Test all 3 mock users
3. Decode and verify JWT claims for each user
4. Test invalid email handling
5. Verify token usability in Authorization header

**Test Fixtures:**
```python
from fastapi.testclient import TestClient
from apps.api.src.main import app

@pytest.fixture
def client():
    return TestClient(app)
```

**Assertion Patterns:**
```python
# Verify JWT claims
import jwt
from shared_config import JWT_SECRET_KEY, JWT_ALGORITHM

decoded = jwt.decode(token, JWT_SECRET_KEY, algorithms=[JWT_ALGORITHM])
assert decoded["sub"] == expected_user_id
assert decoded["email"] == "analyst@acme.com"
assert isinstance(decoded["tenant_ids"], list)
assert len(decoded["tenant_ids"]) > 0
```

### Dependencies
- **Depends on:** Epic 1 Story 1.2 (Shared Configuration Module) - COMPLETE
- **Depends on:** Epic 1 Story 1.5 (FastAPI Basic Setup) - COMPLETE
- **Blocks:** Story 2.2 (User Info Endpoint) - requires auth token for testing

### Security Notes
⚠️ **PoC Simplification:** This endpoint does NOT validate passwords or integrate with real identity providers. For MVP, replace with Azure AD B2C OIDC flow.

Current implementation:
- Email-only lookup (no password)
- Pre-defined mock users in shared_config
- Suitable for PoC validation only

MVP requirements:
- Azure AD B2C integration
- OAuth 2.0 / OIDC standard flows
- Real user authentication

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 0.1 | Initial story creation from Epic 2 | Sarah (PO Agent) |
| 2025-10-12 | 1.0 | Story implementation completed | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (claude-sonnet-4-5-20250929)

### Debug Log References
None - straightforward implementation following shared_config patterns

### Completion Notes List
- Created auth router at apps/api/src/routers/auth.py with POST /api/auth/mock-login endpoint
- Implemented JWT user token generation using shared_config.encode_user_token()
- Added standardized error handling with error code, message, timestamp, and request_id
- Created Pydantic models for MockLoginRequest and TokenResponse
- Added structured logging for authentication attempts (success/failure)
- Wrote comprehensive unit tests in apps/api/tests/test_auth.py
- Wrote integration tests in apps/api/tests/test_auth_integration.py
- Added email-validator dependency to requirements.txt for EmailStr validation
- Registered auth router in main.py with /api/auth prefix
- Endpoint tested successfully with curl - returns Bearer tokens with 3600s expiry
- Error responses verified with 404 for invalid users including proper error format

### File List
**Created:**
- `apps/api/src/models/__init__.py` - Models package init
- `apps/api/src/models/tokens.py` - MockLoginRequest and TokenResponse models
- `apps/api/src/routers/auth.py` - Authentication router with mock login endpoint
- `apps/api/tests/__init__.py` - Tests package init
- `apps/api/tests/test_auth.py` - Unit tests for authentication endpoint
- `apps/api/tests/test_auth_integration.py` - Integration tests for full login flow

**Modified:**
- `apps/api/src/main.py` - Added auth router import and registration
- `apps/api/requirements.txt` - Added email-validator, pytest, and httpx dependencies

## QA Results
_(To be filled by QA Agent)_
