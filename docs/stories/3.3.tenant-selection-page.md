# Story 3.3: Tenant Selection Page

## Status
Accepted

## Story
**As a** user,
**I want** to see a list of tenants I have access to and select one,
**so that** I can exchange my user token for a tenant-scoped token and proceed to dashboards.

## Acceptance Criteria
1. Home page (app/page.tsx) fetches GET /api/me on mount if authenticated
2. If user has multiple tenants, displays tenant selector grid/list with cards for each tenant
3. Each tenant card shows: tenant name, optional description from config_json, "Select" button
4. Tenant cards styled with Tailwind CSS, using branding colors from config_json if present
5. On "Select" button click, calls POST /api/token/exchange with {tenant_id}
6. On successful exchange, stores tenant-scoped token (replaces user token in auth context or separate tenant context)
7. Stores selected tenant metadata (id, name, slug) in zustand tenant store
8. Redirects to /tenant/[tenant_slug] route after successful exchange
9. If user has only one tenant, automatically triggers exchange and redirects (skips selection UI)
10. Loading state shown during tenant discovery and token exchange
11. Error handling for exchange failures (403, 401) with user-friendly messages
12. TypeScript interfaces for tenant data and exchange request/response

## Tasks / Subtasks

- [x] **Task 1: Fetch user tenants** (AC: 1, 10)
  - [x] Update home page to fetch GET /api/me
  - [x] Use userToken from auth context
  - [x] Handle loading state during fetch
  - [x] Handle error states (401, network)

- [x] **Task 2: Create tenant selection UI** (AC: 2, 3, 4)
  - [x] Display tenant cards in grid layout
  - [x] Show tenant name, description
  - [x] Add "Select" button for each
  - [x] Style with Tailwind CSS
  - [x] Apply branding colors from config_json

- [x] **Task 3: Implement token exchange** (AC: 5, 6, 11)
  - [x] Call POST /api/token/exchange on select
  - [x] Pass {tenant_id} in request body
  - [x] Store tenant-scoped token
  - [x] Handle 403 (access denied) errors
  - [x] Handle 401 (invalid token) errors

- [x] **Task 4: Create tenant context/store** (AC: 7)
  - [x] Create zustand store for tenant state
  - [x] Store: selectedTenant {id, name, slug}
  - [x] Store: tenantToken (tenant-scoped JWT)
  - [x] Export useTenant hook

- [x] **Task 5: Implement auto-select for single tenant** (AC: 9)
  - [x] Check if tenants.length === 1
  - [x] Automatically trigger exchange
  - [x] Skip selection UI
  - [x] Redirect to dashboard listing

- [x] **Task 6: Implement redirect after exchange** (AC: 8)
  - [x] Use Next.js router
  - [x] Navigate to /tenant/[tenant_slug]
  - [x] Pass tenant context

- [x] **Task 7: Define TypeScript interfaces** (AC: 12)
  - [x] Define Tenant interface
  - [x] Define TokenExchangeRequest/Response
  - [x] Export from types/tenant.ts

## Dev Notes

### Project Context
This is the **third story** in Epic 3 and represents the **core UX demonstration** of the token exchange mechanism. This page makes the architectural pattern visible to stakeholders.

### Architecture Pattern

**Token Exchange Flow:**
```
User Token (tenant_ids: ["uuid1", "uuid2"]) 
  → User Selects Tenant 
  → POST /api/token/exchange {tenant_id: "uuid1"}
  → Tenant-Scoped Token (tenant_id: "uuid1", role: "viewer")
  → Redirect to Dashboard Listing
```

**Mock User Scenarios:**
- analyst@acme.com → 1 tenant (Acme) → Auto-select
- admin@acme.com → 2 tenants (Acme, Beta) → Show selection UI
- viewer@beta.com → 1 tenant (Beta) → Auto-select

### Dependencies
- **Depends on:** Story 3.1 (Login Page) - provides user token
- **Depends on:** Story 3.2 (Auth Context) - uses auth state
- **Depends on:** Epic 2 Story 2.2 (User Info Endpoint) - /api/me
- **Depends on:** Epic 2 Story 2.3 (Token Exchange) - /api/token/exchange
- **Blocks:** Story 3.4 (Dashboard Listing) - provides tenant context

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | 0.1 | Initial story creation from Epic 3 PRD | Sarah (PO Agent) |
| 2025-10-15 | 1.0 | Implementation complete | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
- Model: claude-sonnet-4-5-20250929
- Agent: Dev Agent (James)
- Date: 2025-10-15

### Debug Log References
None - implementation completed without errors.

### Completion Notes List

**Implementation Complete:**

1. **TypeScript Interfaces Created** (types/tenant.ts)
   - Tenant interface: `{tenant_id, name, slug, config_json}`
   - UserInfoResponse interface: `{user_id, email, tenants[]}`
   - TokenExchangeRequest interface: `{tenant_id}`
   - TokenExchangeResponse interface: `{access_token, token_type, expires_in}`
   - TenantStore interface for zustand store

2. **Zustand Tenant Store** (stores/useTenantStore.ts)
   - Created with zustand `create()` API
   - State: `selectedTenant`, `tenantToken`
   - Actions: `setSelectedTenant()`, `setTenantToken()`, `clearTenant()`
   - Exported as `useTenantStore` hook
   - Added zustand@^4.5.0 to package.json dependencies

3. **Home Page Tenant Selection** (app/page.tsx)
   - Fetches GET /api/me with Bearer token on mount
   - Displays responsive grid of tenant cards (1/2/3 columns)
   - Each card shows: tenant name, description, slug, branding color strip
   - Branding colors extracted from `config_json.branding.primary_color`
   - "Select Tenant" button with loading spinner during exchange

4. **Token Exchange Implementation** (app/page.tsx:69)
   - POST /api/token/exchange with `{tenant_id}` payload
   - Bearer token authentication from auth context
   - Stores tenant-scoped token in zustand store
   - Stores selected tenant metadata in zustand store
   - Error handling for 401 (invalid token), 403 (access denied)
   - Network error handling with user-friendly messages

5. **Auto-Select for Single Tenant** (app/page.tsx:52)
   - Checks if `tenants.length === 1`
   - Automatically calls `handleTenantExchange()` for sole tenant
   - Skips tenant selection UI
   - Immediately redirects to dashboard listing
   - Demonstrates seamless UX for single-tenant users

6. **Navigation and Redirect** (app/page.tsx:115)
   - Uses Next.js `router.push()`
   - Redirects to `/tenant/[tenant_slug]` after successful exchange
   - Tenant slug from tenant metadata
   - Ready for Story 3.4 (Dashboard Listing)

7. **Loading and Error States** (app/page.tsx:130)
   - Loading spinner during tenant discovery
   - Loading spinner on individual tenant cards during exchange
   - Error display for network issues
   - Error display for API failures (401, 403)
   - Retry button for failed operations
   - Logout button in error state

8. **UI/UX Features**
   - Responsive grid layout (mobile/tablet/desktop)
   - Tenant branding colors applied dynamically
   - Loading spinners during async operations
   - Disabled state for buttons during exchange
   - PoC info box explaining token exchange mechanism
   - "No tenants" message for users without access

**Architecture Decisions:**
- Used zustand for tenant state management (AC requirement)
- Tenant token stored separately from user token
- Auto-select implemented with immediate exchange call
- Branding colors applied via inline styles (dynamic from config)
- Error states preserved to show messages while retrying
- Protected with AuthGuard (requires authentication)

**Mock User Scenarios Supported:**
- analyst@acme.com → 1 tenant (Acme) → Auto-select ✓
- admin@acme.com → 2 tenants (Acme, Beta) → Show selection UI ✓
- viewer@beta.com → 1 tenant (Beta) → Auto-select ✓

**Testing Status:**
- All 12 Acceptance Criteria implemented
- All 7 tasks completed
- Manual testing pending (requires Docker services)

**Integration Points:**
- Uses AuthContext for user token
- Uses zustand tenant store
- Ready for Story 3.4 (Dashboard Listing page)
- Redirects to `/tenant/[tenant_slug]` route

### File List
**Created:**
- types/tenant.ts (41 lines)
- stores/useTenantStore.ts (34 lines)

**Modified:**
- app/page.tsx (completely rewritten, 308 lines)
- apps/shell-ui/package.json (added zustand dependency)

## QA Results
_(To be filled by QA Agent)_
