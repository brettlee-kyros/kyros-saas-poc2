# Story 1.2: Shared Configuration Module for JWT Validation

## Status
Ready for Review

## Story
**As a** developer,
**I want** a shared Python package containing JWT configuration settings, validation functions, and data models,
**so that** all services (FastAPI, Dash apps) use identical JWT validation logic, preventing configuration drift.

## Acceptance Criteria
1. packages/shared-config/ created as installable Python package with setup.py or pyproject.toml
2. Shared config module exports JWT_SECRET_KEY, JWT_ALGORITHM ("HS256"), JWT_ISSUER ("kyros-poc")
3. Shared config defines USER_TOKEN_EXPIRY (3600 seconds) and TENANT_TOKEN_EXPIRY (1800 seconds)
4. Pydantic models defined for UserAccessToken (with tenant_ids array) and TenantScopedToken (with single tenant_id)
5. Validation functions provided: validate_user_token(token) and validate_tenant_token(token) that decode JWT and return typed objects
6. Mock user data structure defined with pre-configured users and their tenant mappings
7. All Python apps can import from shared_config module: `from shared_config import JWT_SECRET_KEY, validate_tenant_token`
8. Unit tests verify JWT encoding and decoding work correctly with shared configuration
9. **[BLOCKER RESOLUTION #1]** Dependency resolution strategy documented in `docs/dependency-resolution.md`
10. **[BLOCKER RESOLUTION #1]** JWT library chosen: PyJWT 2.8+ (rationale: lightweight, widely used, simpler API than python-jose)
11. **[BLOCKER RESOLUTION #1]** All Python requirements.txt files use pinned versions (e.g., `PyJWT==2.8.0`, `pydantic==2.5.0`)
12. **[BLOCKER RESOLUTION #1]** Compatibility validated: Dash 2.18+ tested with Python 3.11+ in clean virtual environment
13. **[BLOCKER RESOLUTION #1]** Compatibility validated: aiosqlite async patterns tested with FastAPI 0.115+
14. **[BLOCKER RESOLUTION #1]** Known dependency conflicts or workarounds documented in README troubleshooting section
15. **[BLOCKER RESOLUTION #1]** `scripts/test-dependencies.sh` script created to install and test all requirements in clean environment

## Tasks / Subtasks
- [ ] **Task 1: Create shared-config package structure** (AC: 1)
  - [ ] Create `packages/shared-config/` directory
  - [ ] Create `packages/shared-config/src/shared_config/` package directory
  - [ ] Create `packages/shared-config/src/shared_config/__init__.py` with exports
  - [ ] Create `packages/shared-config/pyproject.toml` for package configuration
  - [ ] Create `packages/shared-config/README.md` documenting usage
  - [ ] Create `packages/shared-config/tests/` directory for unit tests

- [ ] **Task 2: Define JWT configuration constants** (AC: 2, 3)
  - [ ] Create `packages/shared-config/src/shared_config/config.py`
  - [ ] Define `JWT_SECRET_KEY` (use secure random string for PoC, document as mock)
  - [ ] Define `JWT_ALGORITHM = "HS256"`
  - [ ] Define `JWT_ISSUER = "kyros-poc"`
  - [ ] Define `USER_TOKEN_EXPIRY = 3600` (1 hour)
  - [ ] Define `TENANT_TOKEN_EXPIRY = 1800` (30 minutes)
  - [ ] Export all constants in `__init__.py`

- [ ] **Task 3: Create Pydantic token models** (AC: 4)
  - [ ] Create `packages/shared-config/src/shared_config/models.py`
  - [ ] Define `UserAccessToken` Pydantic model with fields: sub, email, tenant_ids (list), iat, exp
  - [ ] Define `TenantScopedToken` Pydantic model with fields: sub, email, tenant_id (string), role, iat, exp
  - [ ] Add field validators for token expiry and tenant_id format
  - [ ] Export models in `__init__.py`

- [ ] **Task 4: Implement JWT validation functions** (AC: 5)
  - [ ] Create `packages/shared-config/src/shared_config/jwt_utils.py`
  - [ ] Implement `validate_user_token(token: str) -> UserAccessToken` using PyJWT
  - [ ] Implement `validate_tenant_token(token: str) -> TenantScopedToken` using PyJWT
  - [ ] Implement `encode_user_token(user_data: dict) -> str` helper
  - [ ] Implement `encode_tenant_token(tenant_data: dict) -> str` helper
  - [ ] Add proper error handling for expired/invalid tokens
  - [ ] Export validation functions in `__init__.py`

- [ ] **Task 5: Define mock user data structure** (AC: 6)
  - [ ] Create `packages/shared-config/src/shared_config/mock_users.py`
  - [ ] Define mock users matching database seed data (3 users from Story 1.3)
  - [ ] Create pre-generated user access tokens for each mock user
  - [ ] Document mock user credentials and tenant mappings
  - [ ] Export `MOCK_USERS` and `MOCK_TOKENS` in `__init__.py`

- [ ] **Task 6: Write unit tests** (AC: 8)
  - [ ] Create `packages/shared-config/tests/test_jwt_utils.py`
  - [ ] Test user token encoding and decoding round-trip
  - [ ] Test tenant token encoding and decoding round-trip
  - [ ] Test expired token rejection
  - [ ] Test invalid signature rejection
  - [ ] Test Pydantic model validation
  - [ ] Test token with invalid claims structure
  - [ ] Verify all tests pass with pytest

- [ ] **Task 7: Document dependency resolution strategy** (AC: 9)
  - [ ] Create `docs/dependency-resolution.md`
  - [ ] Document PyJWT 2.8+ selection rationale vs python-jose
  - [ ] List all pinned versions and compatibility matrix
  - [ ] Document Python 3.11+ requirement
  - [ ] Document version pinning strategy for all packages

- [ ] **Task 8: Validate dependency compatibility** (AC: 10-13)
  - [ ] Test Dash 2.18+ with Python 3.11+ in clean venv
  - [ ] Test aiosqlite async patterns with FastAPI 0.115+
  - [ ] Test PyJWT 2.8.0 with Pydantic 2.5.0 compatibility
  - [ ] Verify all Python apps can import shared_config module
  - [ ] Document any compatibility issues found

- [ ] **Task 9: Create dependency testing script** (AC: 15)
  - [ ] Create `scripts/test-dependencies.sh` bash script
  - [ ] Script creates clean Python virtual environment
  - [ ] Script installs all requirements from all apps + shared-config
  - [ ] Script runs smoke tests (imports all modules)
  - [ ] Script reports any conflicts or errors
  - [ ] Make script executable and document in README

- [ ] **Task 10: Document troubleshooting and install shared-config** (AC: 7, 14)
  - [ ] Add known issues section to root README.md if any found
  - [ ] Document shared-config installation in all Python app requirements
  - [ ] Update `apps/api/requirements.txt` to include `-e ../../packages/shared-config`
  - [ ] Update `apps/dash-app-clv/requirements.txt` to include shared-config
  - [ ] Update `apps/dash-app-risk/requirements.txt` to include shared-config
  - [ ] Verify all Python apps can successfully import from shared_config

- [ ] **Task 11: Integration validation** (AC: 7, 8)
  - [ ] Create test script in each Python app that imports shared_config
  - [ ] Verify JWT_SECRET_KEY accessible from all apps
  - [ ] Verify validation functions work from all apps
  - [ ] Run unit tests and verify all pass
  - [ ] Verify all acceptance criteria are met

## Dev Notes

### Project Context
This is the **second story** in Epic 1 (Foundation & Shared Configuration). This shared configuration module is **CRITICAL** - it is a dependency for Stories 1.5 (FastAPI), 1.6 (Next.js), and all of Epic 2 (Auth & Token Exchange). All services MUST use this shared module to prevent JWT configuration drift.

### Previous Story Insights
Story 1.1 established the monorepo structure with `packages/` directory and workspace configuration. This story builds on that foundation by creating the first shared package.

### Dependency Architecture Pattern
[Source: architecture/16-coding-standards.md]

**CRITICAL RULE:** ALL JWT settings (secret, algorithm, expiry) MUST be imported from shared-config module. Never hardcode these values in any service.

**Import Pattern:**
```python
# In FastAPI, Dash apps - ALWAYS import from shared_config
from shared_config import JWT_SECRET_KEY, JWT_ALGORITHM, validate_tenant_token
from shared_config.models import TenantScopedToken
```

### JWT Data Models
[Source: architecture/4-data-models.md#4.6]

**UserAccessToken (multi-tenant):**
```python
from pydantic import BaseModel, Field
from typing import List

class UserAccessToken(BaseModel):
    sub: str = Field(..., description="User UUID")
    email: str = Field(..., description="User email")
    tenant_ids: List[str] = Field(..., description="Array of tenant UUIDs")
    iat: int = Field(..., description="Issued at timestamp")
    exp: int = Field(..., description="Expiration timestamp")
```

**TenantScopedToken (single tenant):**
```python
from pydantic import BaseModel, Field
from typing import Literal

class TenantScopedToken(BaseModel):
    sub: str = Field(..., description="User UUID")
    email: str = Field(..., description="User email")
    tenant_id: str = Field(..., description="Single tenant UUID")
    role: Literal['admin', 'viewer'] = Field(..., description="User role for this tenant")
    iat: int = Field(..., description="Issued at timestamp")
    exp: int = Field(..., description="Expiration timestamp (short-lived)")
```

### Mock User Data Structure
[Source: architecture/8-database-schema.md + prd/epic-1 AC #6]

Mock users MUST match database seed data from Story 1.3:

```python
MOCK_USERS = {
    "analyst@acme.com": {
        "user_id": "f8d1e2c3-4b5a-6789-abcd-ef1234567890",
        "email": "analyst@acme.com",
        "password": "demo123",  # PoC only - mock auth
        "tenant_ids": ["8e1b3d5b-7c9a-4e2f-b1d3-a5c7e9f12345"],  # Acme only
        "roles": {
            "8e1b3d5b-7c9a-4e2f-b1d3-a5c7e9f12345": "viewer"
        }
    },
    "admin@acme.com": {
        "user_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
        "email": "admin@acme.com",
        "password": "demo123",
        "tenant_ids": [
            "8e1b3d5b-7c9a-4e2f-b1d3-a5c7e9f12345",  # Acme
            "2450a2f8-3b7e-4eab-9b4a-1f73d9a0b1c4"   # Beta
        ],
        "roles": {
            "8e1b3d5b-7c9a-4e2f-b1d3-a5c7e9f12345": "admin",
            "2450a2f8-3b7e-4eab-9b4a-1f73d9a0b1c4": "admin"
        }
    },
    "viewer@beta.com": {
        "user_id": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
        "email": "viewer@beta.com",
        "password": "demo123",
        "tenant_ids": ["2450a2f8-3b7e-4eab-9b4a-1f73d9a0b1c4"],  # Beta only
        "roles": {
            "2450a2f8-3b7e-4eab-9b4a-1f73d9a0b1c4": "viewer"
        }
    }
}
```

### PyJWT Implementation Pattern
[Source: prd/epic-1 AC #10]

**JWT Library Choice: PyJWT 2.8+**

Rationale:
- Lightweight and widely used in Python ecosystem
- Simpler API than python-jose
- Active maintenance and security updates
- Native integration with Pydantic
- No additional dependencies (cryptography for RS256 optional)

**Validation Function Pattern:**
```python
import jwt
from datetime import datetime, timedelta
from shared_config.config import JWT_SECRET_KEY, JWT_ALGORITHM
from shared_config.models import TenantScopedToken

def validate_tenant_token(token: str) -> TenantScopedToken:
    """Decode and validate tenant-scoped JWT token."""
    try:
        payload = jwt.decode(
            token,
            JWT_SECRET_KEY,
            algorithms=[JWT_ALGORITHM],
            options={"verify_exp": True}
        )
        return TenantScopedToken(**payload)
    except jwt.ExpiredSignatureError:
        raise ValueError("Token has expired")
    except jwt.InvalidTokenError as e:
        raise ValueError(f"Invalid token: {str(e)}")
```

### Package Installation Pattern
[Source: prd/epic-1 AC #7, #11]

**pyproject.toml structure:**
```toml
[build-system]
requires = ["setuptools>=68.0", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "shared-config"
version = "0.1.0"
description = "Shared JWT configuration and validation for Kyros SaaS PoC"
requires-python = ">=3.11"
dependencies = [
    "PyJWT==2.8.0",
    "pydantic==2.5.0",
]

[tool.setuptools.packages.find]
where = ["src"]
```

**Installation in other apps (requirements.txt):**
```
# Add to apps/api/requirements.txt, apps/dash-app-clv/requirements.txt, apps/dash-app-risk/requirements.txt
-e ../../packages/shared-config
```

### Dependency Testing Script
[Source: prd/epic-1 AC #15]

**scripts/test-dependencies.sh:**
```bash
#!/bin/bash
set -e

echo "Creating clean Python virtual environment..."
python3.11 -m venv /tmp/kyros-test-venv
source /tmp/kyros-test-venv/bin/activate

echo "Installing shared-config..."
pip install -e packages/shared-config

echo "Testing FastAPI dependencies..."
pip install -r apps/api/requirements.txt
python -c "import fastapi; import aiosqlite; import shared_config; print('✓ FastAPI deps OK')"

echo "Testing Dash dependencies..."
pip install -r apps/dash-app-clv/requirements.txt
python -c "import dash; import shared_config; print('✓ Dash deps OK')"

echo "Running shared-config unit tests..."
pip install pytest
pytest packages/shared-config/tests/

echo "✓ All dependency tests passed!"
deactivate
rm -rf /tmp/kyros-test-venv
```

### JWT Configuration Constants
[Source: prd/epic-1 AC #2, #3]

```python
# packages/shared-config/src/shared_config/config.py
import os
from datetime import timedelta

# ⚠️ PoC ONLY: Hardcoded secret. MVP must use environment variable or secrets manager
JWT_SECRET_KEY = "kyros-poc-secret-key-CHANGE-IN-PRODUCTION-12345678"
JWT_ALGORITHM = "HS256"
JWT_ISSUER = "kyros-poc"

# Token expiry durations (in seconds)
USER_TOKEN_EXPIRY = 3600  # 1 hour (multi-tenant user token)
TENANT_TOKEN_EXPIRY = 1800  # 30 minutes (tenant-scoped token)

# ⚠️ MVP TODO: Load JWT_SECRET_KEY from environment variable
# JWT_SECRET_KEY = os.environ["JWT_SECRET_KEY"]
```

### Testing
[Source: architecture/15-testing-strategy.md]

**Unit Tests Required** (AC #8):

Test coverage:
1. JWT encoding round-trip (encode → decode → verify claims)
2. JWT decoding with valid token
3. Expired token rejection
4. Invalid signature rejection
5. Pydantic model validation (missing fields, wrong types)
6. Token with extra claims (should be ignored)
7. Token with invalid claims structure

**Test file:** `packages/shared-config/tests/test_jwt_utils.py`

**Test execution:**
```bash
pytest packages/shared-config/tests/ -v
```

**Definition of Done:**
- Shared-config package installable via pip
- All JWT constants exported and accessible
- Pydantic models defined and validated
- JWT validation functions work correctly
- Mock user data structure complete
- All Python apps can import shared_config
- Unit tests pass 100%
- Dependency compatibility validated
- Dependency testing script works
- Documentation complete

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-11 | 0.1 | Initial story creation from Epic 1 | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
_(To be filled during implementation)_

### Debug Log References
_(To be filled during implementation)_

### Completion Notes List
_(To be filled during implementation)_

### File List
**Created:**
_(To be filled during implementation)_

**Modified:**
_(To be filled during implementation)_

## QA Results
_(To be filled by QA Agent)_
